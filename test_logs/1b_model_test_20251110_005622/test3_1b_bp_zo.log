Using device: cuda
Logs will be stored in /home/polyu/pcllzy/zo_withbp/logs/test3_1b_bp_zo_20251110_005625
成功从本地加载tokenizer: /home/polyu/pcllzy/zo_withbp/tokenizer
Creating model: 1B
Description: 大型模型，约1B参数，需要较大显存
Configuration:
  - Embedding dim: 1536
  - Layers: 24
  - Attention heads: 24
  - Max position: 1024
  - Vocab size: 50258

Model created successfully!
Total parameters: 758,728,704 (758.73M)
Trainable parameters: 758,728,704 (758.73M)
Loading dataset: dclm-pubmedqa-merged
Description: DCLM和PubMedQA合并数据集，共20,000条，已统一为text字段
Loading local dataset from: /home/polyu/pcllzy/zo_withbp/datasets_subset/dclm_pubmedqa_merged
Tokenizing dataset...
Reading dataset:   0%|          | 0/20 [00:00<?, ?it/s]Reading dataset: 82it [00:00, 816.95it/s]              Reading dataset: 164it [00:00, 714.06it/s]Reading dataset: 237it [00:00, 634.32it/s]Reading dataset: 317it [00:00, 691.29it/s]Reading dataset: 388it [00:00, 616.32it/s]Reading dataset: 457it [00:00, 605.26it/s]Reading dataset: 535it [00:00, 619.54it/s]Reading dataset: 598it [00:00, 615.08it/s]Reading dataset: 682it [00:01, 677.91it/s]Reading dataset: 751it [00:01, 617.82it/s]Reading dataset: 817it [00:01, 628.26it/s]Reading dataset: 906it [00:01, 697.91it/s]Reading dataset: 978it [00:01, 696.40it/s]Reading dataset: 1049it [00:01, 595.02it/s]Reading dataset: 1115it [00:01, 609.56it/s]Reading dataset: 1179it [00:01, 579.39it/s]Reading dataset: 1246it [00:01, 597.11it/s]Reading dataset: 1308it [00:02, 524.19it/s]Reading dataset: 1422it [00:02, 677.92it/s]Reading dataset: 1497it [00:02, 692.23it/s]Reading dataset: 1570it [00:02, 645.25it/s]Reading dataset: 1652it [00:02, 659.12it/s]Reading dataset: 1723it [00:02, 656.63it/s]Reading dataset: 1819it [00:02, 734.57it/s]Reading dataset: 1895it [00:02, 719.50it/s]Reading dataset: 1969it [00:03, 637.07it/s]Reading dataset: 2040it [00:03, 654.92it/s]Reading dataset: 2118it [00:03, 679.82it/s]Reading dataset: 2188it [00:03, 681.84it/s]Reading dataset: 2258it [00:03, 661.05it/s]Reading dataset: 2325it [00:03, 632.26it/s]Reading dataset: 2395it [00:03, 650.61it/s]Reading dataset: 2461it [00:03, 617.18it/s]Reading dataset: 2524it [00:03, 568.96it/s]Reading dataset: 2593it [00:04, 599.82it/s]Reading dataset: 2659it [00:04, 614.44it/s]Reading dataset: 2722it [00:04, 616.36it/s]Reading dataset: 2802it [00:04, 668.39it/s]Reading dataset: 2870it [00:04, 460.36it/s]Reading dataset: 2934it [00:04, 499.60it/s]Reading dataset: 2992it [00:04, 502.26it/s]Reading dataset: 3062it [00:04, 551.38it/s]Reading dataset: 3158it [00:05, 658.42it/s]Reading dataset: 3229it [00:05, 622.29it/s]Reading dataset: 3298it [00:05, 639.15it/s]Reading dataset: 3365it [00:05, 646.67it/s]Reading dataset: 3432it [00:05, 653.05it/s]Reading dataset: 3499it [00:05, 609.40it/s]Reading dataset: 3591it [00:05, 693.93it/s]Reading dataset: 3667it [00:05, 712.06it/s]Reading dataset: 3740it [00:05, 576.15it/s]Reading dataset: 3803it [00:06, 535.69it/s]Reading dataset: 3862it [00:06, 524.69it/s]Reading dataset: 3937it [00:06, 580.76it/s]Reading dataset: 3998it [00:06, 586.81it/s]Reading dataset: 4059it [00:06, 559.86it/s]Reading dataset: 4148it [00:06, 648.25it/s]Reading dataset: 4215it [00:06, 641.01it/s]Reading dataset: 4285it [00:06, 655.65it/s]Reading dataset: 4352it [00:06, 625.96it/s]Reading dataset: 4416it [00:07, 600.77it/s]Reading dataset: 4486it [00:07, 627.62it/s]Reading dataset: 4565it [00:07, 603.59it/s]Reading dataset: 4627it [00:07, 590.62it/s]Reading dataset: 4687it [00:07, 547.93it/s]Reading dataset: 4744it [00:07, 553.68it/s]Reading dataset: 4800it [00:07, 543.32it/s]Reading dataset: 4867it [00:07, 562.07it/s]Reading dataset: 4934it [00:08, 588.88it/s]Reading dataset: 5002it [00:08, 614.05it/s]Reading dataset: 5064it [00:08, 565.34it/s]Reading dataset: 5128it [00:08, 584.79it/s]Reading dataset: 5188it [00:08, 398.85it/s]Reading dataset: 5244it [00:08, 432.96it/s]Reading dataset: 5299it [00:08, 459.89it/s]Reading dataset: 5351it [00:09, 352.63it/s]Reading dataset: 5437it [00:09, 447.56it/s]Reading dataset: 5490it [00:09, 353.69it/s]Reading dataset: 5566it [00:09, 430.35it/s]Reading dataset: 5634it [00:09, 484.70it/s]Reading dataset: 5707it [00:09, 537.44it/s]Reading dataset: 5768it [00:09, 528.29it/s]Reading dataset: 5836it [00:09, 560.35it/s]Reading dataset: 5901it [00:10, 579.13it/s]Reading dataset: 5999it [00:10, 687.00it/s]Reading dataset: 6071it [00:10, 663.14it/s]Reading dataset: 6156it [00:10, 696.29it/s]Reading dataset: 6241it [00:10, 737.53it/s]Reading dataset: 6317it [00:10, 654.98it/s]Reading dataset: 6405it [00:10, 699.77it/s]Reading dataset: 6478it [00:10, 629.43it/s]Reading dataset: 6544it [00:11, 574.79it/s]Reading dataset: 6604it [00:11, 541.27it/s]Reading dataset: 6666it [00:11, 551.40it/s]Reading dataset: 6723it [00:11, 483.40it/s]Reading dataset: 6785it [00:11, 509.88it/s]Reading dataset: 6867it [00:11, 562.24it/s]Reading dataset: 6941it [00:11, 606.10it/s]Reading dataset: 7004it [00:11, 571.23it/s]Reading dataset: 7084it [00:11, 630.27it/s]Reading dataset: 7169it [00:12, 659.46it/s]Reading dataset: 7251it [00:12, 694.74it/s]Reading dataset: 7322it [00:12, 525.75it/s]Reading dataset: 7382it [00:12, 528.89it/s]Reading dataset: 7458it [00:12, 584.78it/s]Reading dataset: 7522it [00:12, 598.59it/s]Reading dataset: 7586it [00:12, 448.28it/s]Reading dataset: 7641it [00:13, 468.81it/s]Reading dataset: 7705it [00:13, 507.32it/s]Reading dataset: 7787it [00:13, 585.32it/s]Reading dataset: 7851it [00:13, 592.49it/s]Reading dataset: 7914it [00:13, 536.75it/s]Reading dataset: 7979it [00:13, 565.65it/s]Reading dataset: 8039it [00:13, 550.65it/s]Reading dataset: 8101it [00:13, 556.13it/s]Reading dataset: 8174it [00:13, 591.36it/s]Reading dataset: 8236it [00:14, 595.13it/s]Reading dataset: 8326it [00:14, 679.87it/s]Reading dataset: 8396it [00:14, 664.30it/s]Reading dataset: 8476it [00:14, 701.40it/s]Reading dataset: 8559it [00:14, 736.17it/s]Reading dataset: 8634it [00:14, 737.23it/s]Reading dataset: 8722it [00:14, 771.32it/s]Reading dataset: 8800it [00:14, 708.49it/s]Reading dataset: 8888it [00:14, 751.42it/s]Reading dataset: 8965it [00:14, 736.31it/s]Reading dataset: 9040it [00:15, 657.92it/s]Reading dataset: 9108it [00:15, 649.27it/s]Reading dataset: 9175it [00:15, 572.53it/s]Reading dataset: 9267it [00:15, 659.41it/s]Reading dataset: 9337it [00:15, 581.51it/s]Reading dataset: 9425it [00:15, 654.79it/s]Reading dataset: 9506it [00:15, 695.01it/s]Reading dataset: 9579it [00:16, 501.58it/s]Reading dataset: 9665it [00:16, 577.30it/s]Reading dataset: 9741it [00:16, 606.12it/s]Reading dataset: 9809it [00:16, 560.44it/s]Reading dataset: 9881it [00:16, 579.43it/s]Reading dataset: 9953it [00:16, 595.75it/s]Reading dataset: 10032it [00:16, 645.09it/s]Reading dataset: 10100it [00:16, 614.65it/s]Reading dataset: 10164it [00:17, 605.72it/s]Reading dataset: 10227it [00:17, 592.80it/s]Reading dataset: 10307it [00:17, 648.88it/s]Reading dataset: 10390it [00:17, 697.78it/s]Reading dataset: 10476it [00:17, 742.36it/s]Reading dataset: 10552it [00:17, 532.55it/s]Reading dataset: 10615it [00:17, 530.46it/s]Reading dataset: 10676it [00:17, 549.13it/s]Reading dataset: 10737it [00:18, 530.95it/s]Reading dataset: 10799it [00:18, 394.39it/s]Reading dataset: 10854it [00:18, 405.29it/s]Reading dataset: 10920it [00:18, 460.09it/s]Reading dataset: 10980it [00:18, 487.63it/s]Reading dataset: 11034it [00:18, 476.43it/s]Reading dataset: 11111it [00:18, 507.90it/s]Reading dataset: 11170it [00:18, 523.48it/s]Reading dataset: 11227it [00:19, 528.69it/s]Reading dataset: 11288it [00:19, 532.54it/s]Reading dataset: 11351it [00:19, 557.39it/s]Reading dataset: 11438it [00:19, 644.19it/s]Reading dataset: 11519it [00:19, 690.88it/s]Reading dataset: 11605it [00:19, 724.38it/s]Reading dataset: 11679it [00:19, 713.84it/s]Reading dataset: 11768it [00:19, 756.73it/s]Reading dataset: 11845it [00:19, 753.64it/s]Reading dataset: 11921it [00:20, 693.16it/s]Reading dataset: 12015it [00:20, 759.03it/s]Reading dataset: 12099it [00:20, 781.81it/s]Reading dataset: 12179it [00:20, 731.80it/s]Reading dataset: 12254it [00:20, 715.74it/s]Reading dataset: 12327it [00:20, 686.09it/s]Reading dataset: 12399it [00:20, 694.24it/s]Reading dataset: 12469it [00:20, 658.52it/s]Reading dataset: 12536it [00:20, 618.25it/s]Reading dataset: 12611it [00:21, 651.66it/s]Reading dataset: 12678it [00:21, 649.75it/s]Reading dataset: 12758it [00:21, 685.25it/s]Reading dataset: 12828it [00:21, 670.50it/s]Reading dataset: 12896it [00:21, 671.49it/s]Reading dataset: 12983it [00:21, 728.47it/s]Reading dataset: 13079it [00:21, 793.04it/s]Reading dataset: 13159it [00:21, 676.48it/s]Reading dataset: 13237it [00:21, 703.16it/s]Reading dataset: 13326it [00:22, 749.34it/s]Reading dataset: 13404it [00:22, 678.79it/s]Reading dataset: 13475it [00:22, 665.34it/s]Reading dataset: 13584it [00:22, 777.58it/s]Reading dataset: 13665it [00:22, 774.08it/s]Reading dataset: 13745it [00:22, 749.82it/s]Reading dataset: 13822it [00:22, 642.90it/s]Reading dataset: 13890it [00:22, 620.76it/s]Reading dataset: 13975it [00:22, 676.81it/s]Reading dataset: 14055it [00:23, 648.83it/s]Reading dataset: 14141it [00:23, 702.91it/s]Reading dataset: 14214it [00:23, 580.33it/s]Reading dataset: 14286it [00:23, 598.19it/s]Reading dataset: 14350it [00:23, 584.19it/s]Reading dataset: 14417it [00:23, 604.61it/s]Reading dataset: 14480it [00:23, 600.78it/s]Reading dataset: 14556it [00:23, 644.14it/s]Reading dataset: 14622it [00:24, 614.85it/s]Reading dataset: 14685it [00:24, 593.74it/s]Reading dataset: 14746it [00:24, 597.34it/s]Reading dataset: 14813it [00:24, 615.83it/s]Reading dataset: 14894it [00:24, 668.26it/s]Reading dataset: 14962it [00:24, 610.60it/s]Reading dataset: 15025it [00:24, 573.03it/s]Reading dataset: 15084it [00:24, 565.24it/s]Reading dataset: 15143it [00:24, 570.92it/s]Reading dataset: 15212it [00:25, 598.76it/s]Reading dataset: 15273it [00:25, 524.12it/s]Reading dataset: 15328it [00:25, 521.59it/s]Reading dataset: 15382it [00:25, 503.58it/s]Reading dataset: 15450it [00:25, 546.67it/s]Reading dataset: 15513it [00:25, 568.59it/s]Reading dataset: 15571it [00:25, 520.51it/s]Reading dataset: 15640it [00:25, 560.69it/s]Reading dataset: 15700it [00:25, 569.90it/s]Reading dataset: 15758it [00:26, 518.70it/s]Reading dataset: 15825it [00:26, 555.39it/s]Reading dataset: 15905it [00:26, 609.19it/s]Reading dataset: 15968it [00:26, 524.78it/s]Reading dataset: 16024it [00:26, 502.09it/s]Reading dataset: 16091it [00:26, 529.08it/s]Reading dataset: 16192it [00:26, 650.37it/s]Reading dataset: 16271it [00:26, 677.68it/s]Reading dataset: 16348it [00:27, 700.00it/s]Reading dataset: 16423it [00:27, 708.01it/s]Reading dataset: 16495it [00:27, 643.01it/s]Reading dataset: 16565it [00:27, 643.86it/s]Reading dataset: 16631it [00:27, 439.23it/s]Reading dataset: 16688it [00:27, 466.41it/s]Reading dataset: 16756it [00:27, 514.05it/s]Reading dataset: 16815it [00:27, 513.90it/s]Reading dataset: 16878it [00:28, 539.82it/s]Reading dataset: 16960it [00:28, 611.62it/s]Reading dataset: 17035it [00:28, 647.09it/s]Reading dataset: 17103it [00:28, 499.61it/s]Reading dataset: 17192it [00:28, 522.15it/s]Reading dataset: 17253it [00:28, 541.89it/s]Reading dataset: 17318it [00:28, 559.94it/s]Reading dataset: 17394it [00:28, 609.21it/s]Reading dataset: 17458it [00:29, 567.98it/s]Reading dataset: 17518it [00:29, 571.79it/s]Reading dataset: 17588it [00:29, 573.21it/s]Reading dataset: 17688it [00:29, 680.61it/s]Reading dataset: 17778it [00:29, 737.02it/s]Reading dataset: 17854it [00:29, 627.24it/s]Reading dataset: 17925it [00:29, 646.33it/s]Reading dataset: 17993it [00:29, 579.52it/s]Reading dataset: 18075it [00:30, 633.53it/s]Reading dataset: 18152it [00:30, 660.09it/s]Reading dataset: 18221it [00:30, 631.52it/s]Reading dataset: 18286it [00:30, 615.71it/s]Reading dataset: 18360it [00:30, 647.36it/s]Reading dataset: 18426it [00:30, 627.98it/s]Reading dataset: 18490it [00:30, 589.81it/s]Reading dataset: 18578it [00:30, 665.41it/s]Reading dataset: 18669it [00:30, 728.97it/s]Reading dataset: 18754it [00:31, 761.43it/s]Reading dataset: 18832it [00:31, 742.29it/s]Reading dataset: 18908it [00:31, 743.98it/s]Reading dataset: 18984it [00:31, 697.82it/s]Reading dataset: 19065it [00:31, 727.16it/s]Reading dataset: 19139it [00:31, 669.15it/s]Reading dataset: 19213it [00:31, 625.35it/s]Reading dataset: 19277it [00:31, 617.87it/s]Reading dataset: 19358it [00:31, 642.54it/s]Reading dataset: 19432it [00:32, 663.79it/s]Reading dataset: 19502it [00:32, 664.28it/s]Reading dataset: 19573it [00:32, 676.98it/s]Reading dataset: 19688it [00:32, 805.06it/s]Reading dataset: 19770it [00:32, 504.54it/s]Reading dataset: 19837it [00:32, 533.95it/s]Reading dataset: 19915it [00:32, 589.05it/s]Reading dataset: 19989it [00:32, 625.13it/s]Reading dataset: 20000it [00:33, 606.00it/s]
Creating blocks of size 128...
Dataset prepared. Total blocks: 108693
Saving dataset to cache: cache/dataset_dclm-pubmedqa-merged_bs128_samples20.pkl
Training scope: full model.
Trainable parameters: 758.73M (100.00% of total)
ZO queries will use fresh data batches per direction.
Using optimizer: MuDaMW
Epoch 1/1:   0%|          | 0/108693 [00:00<?, ?it/s]Epoch 1/1:   0%|          | 0/108693 [00:02<?, ?it/s]
Traceback (most recent call last):
  File "/home/polyu/pcllzy/zo_withbp/core/reproduce_zo_paper_1106.py", line 1606, in <module>
    train(
  File "/home/polyu/pcllzy/zo_withbp/core/reproduce_zo_paper_1106.py", line 1268, in train
    grad_paramwise = zo_gradient_estimator(
  File "/home/polyu/anaconda3/envs/zo_withbp/lib/python3.9/site-packages/torch/utils/_contextlib.py", line 115, in decorate_context
    return func(*args, **kwargs)
  File "/home/polyu/pcllzy/zo_withbp/core/reproduce_zo_paper_1106.py", line 120, in zo_gradient_estimator
    raw_direction = next(manual_iter)
  File "/home/polyu/pcllzy/zo_withbp/core/reproduce_zo_paper_1106.py", line 327, in generator
    perm = torch.randperm(candidate_pool_size, device=device)
torch.cuda.OutOfMemoryError: CUDA out of memory. Tried to allocate 1.02 GiB. GPU 0 has a total capacty of 31.74 GiB of which 959.19 MiB is free. Including non-PyTorch memory, this process has 30.80 GiB memory in use. Of the allocated memory 29.12 GiB is allocated by PyTorch, and 1.31 GiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting max_split_size_mb to avoid fragmentation.  See documentation for Memory Management and PYTORCH_CUDA_ALLOC_CONF
